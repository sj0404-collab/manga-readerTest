name: Build APK (React Native Edition)
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. Распаковка (как и раньше)
      - name: Extract ZIP
        run: |
          ZIP_FILE=$(ls *.zip | head -n 1)
          unzip -o "$ZIP_FILE" -d temp_extract
          # Переносим всё из temp_extract/project в корень
          cp -rf temp_extract/project/* . || cp -rf temp_extract/* .
          rm -rf temp_extract

      # 2. Установка Node.js (без этого React Native не соберется)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Установка зависимостей (тот самый npm install)
      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps

      # 4. Настройка Java и Android SDK
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 5. Генерация нативных файлов (если папки android нет, Expo её создаст)
      - name: Expo Prebuild (if needed)
        run: |
          if [ ! -d "android" ]; then
            npx expo prebuild --platform android
          fi

      # 6. Фикс мелких косяков версий
      - name: Grant Execute Permission
        run: |
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew
          elif [ -f "gradlew" ]; then
            chmod +x gradlew
          fi

      # 7. СБОРКА APK
      - name: Build Android APK
        run: |
          if [ -d "android" ]; then
            cd android && ./gradlew assembleDebug --no-daemon
          else
            ./gradlew assembleDebug --no-daemon
          fi

      # 8. Выгрузка готового файла
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: manga-reader-apk
          path: |
            android/app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/debug/*.apk
